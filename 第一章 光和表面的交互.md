# 一、光合表面的交互
计算机图形学：模拟光和物体表面交互的光学原理

渲染过程中的两个难点：物体表面的半球积分运算、光线与整个场景的最近相交位置。

解决问题的两类方式：
- 基于有限元分解的辐射度理论、基于蒙特卡洛积分的光线追踪技术。
- 拆分渲染方程

有限元方法：将无限维的空间分解为有限维度的的积分，通过求出每个有限元的均值计算积分。

蒙特卡洛方法：使用随机采样，使用抽样近似计算积分方程的值。

![快速的光照计算渲染场景的方法](/pic/快速的光照计算渲染场景分类.png)

## 1.1 什么是全局光照

全局光照模型和局部光照：仅考虑光从光源出发，经过表面一次反射或折射后到达人眼，这种不考虑非光源表面对着色的影响的光照模型称为局部光照模型。相反称为全局光照模型。

全局光照包含的内容：阴影、环境遮挡、反射、间接光照、焦散、散射。

阴影：硬阴影只记录物体的边缘的信息，软阴影通常由面光源产生。

环境遮挡：通常没有办法使用光栅化的方式生成，AO 包含静态 AO 和动态 AO。静态 AO 通常使用 AO 贴图实现。动态 AO 通常使用 SSAO 和距离场加速 AO 计算。

反射：通常会使用环境贴图实现。

间接光照：最重要全局光照效果，计算特别昂贵。其设计渲染方程针对整个半球空间的积分计算。半球空间的积分和 AO 的计算方式类似，所以计算间接光照的时候会同时把 AO 计算了，例如Unreal Engine 4 中的光追追踪的 GI 的实现，以及 SSGI [(SSGI shader 实现)](https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Shaders/Private/SSRT/SSRTDiffuseIndirect.usf) 的实现都是同时计算 AO 和间接光照。静态的场景通常使用光照贴图实现间接漫反射。动态场景使用光照探针。

焦散：渲染尤其困难，因为形成焦散的光线采样率极低。

散射：次表面散射，人体的皮肤的渲染通常需要使用到的技术。

## 1.2 辐射度量学

辐射度量学中的基本度量

辐射能量、辐射通量、辐射照度、辐射强度、辐射亮度

![辐射度量学中的基本度量](/pic/辐射度量学中的基本度量.jpeg)

立体角：一个物体相对于一个点的立体角的大小等于这个物体投影到以该点为球心的单位求上的面积。

### 1.2.1 辐射能量

单位为焦耳J，Q=hv v是频率，h为普朗克常数。蓝色具有更高的能量，红色具有更低的能量

### 1.2.2 辐射通量

每秒钟发射的功率，单位为瓦特W。

### 1.2.3 辐射亮度

辐射亮度测试的是单束光的测量，他也是人眼和相机测量的度量，计算渲染方程的目标通常是计算表面的点到摄像机的辐射度量。

### 1.2.4 辐射强度

表示光源光照的度量。

### 1.2.5 辐射照度

它是点沿各个方向对辐射亮度的积分。他用来表述表面的一个点接收的所有的光照，而渲染方程所要处理的正是通过反射定律和后面讲述的理论，计算出沿某个观察方向的出射亮度。出射亮度一般和入射角度有关系，但是漫反射表面它沿各个方向的光照是相同的，所有的入射光照的积分就可以被单独的计算出来，因此辐射照度是漫反射的表面的重要度量，实际上漫反射贴图存储的正是辐射照度值。

## 1.3 物体表面的着色

### 1.3.1 几何光学模型

物理光学：光在介质中以波的形式传播，可以解释光的干涉和衍射现象。

几何光学：一种近似模型，忽略光的波长、光线直线传播。被计算机图形学广泛采用。

几何光学的假设：
- 物体表面是绝对光滑的
- 光可以被发射、反射或者是传播
- 光以无线快的速度沿直线传播

### 1.3.2 光和表面的交互

1.光从光源或者是其他发光体中发射出来
2.光场景的物体进行交互，部分被反射，部分被吸收并可能经过一定传播路径后沿其他方向散射出来
3.光被摄像机吸收形成图像。

#### 1.3.2.1 光源

光源的种类：平行光、点光源、聚光灯、面光源（比较难以计算的一种光源，UE4 中也包含这种类型的光源[ue4 官方文档](https://docs.unrealengine.com/en-US/Engine/Rendering/LightingAndShadows/LightTypes/RectLights/index.html)）

表面接收的光照使用辐射照度E表示，而光源使用辐射强度I表示，两者之间的关系和距离的平方成反比：E=（Icosθ）/(r^2) 通常会使用距离函数来替换距离的平方，减少光照的计算。

#### 1.3.2.2 材质

材质决定每个表面最终呈现什么颜色。

在计算机图形雪中通常是”形“和”色“分离，由网格表示形状，由材质表示颜色，材质通常包含贴图和shader。（严格意义上来说，贴图和shader 也能表示形状。例如游戏引擎中常用的置换贴图，网格细分）

材质分为两大类：金属和非金属

通常将反射和漫反射区分开分别称为光泽（specular）和漫反射（diffuse）

光泽通常由光线的直接反射形成，漫反射通常由光进入物体，经历折射吸收、多次散射之后，重新从表面散射回去形成。漫反射光可以接受全方向的光，因此需要对全空间进行积分计算。与方向无关的参数可以记录在贴图中，和方向有关的反射特性则记录在着色器代码中。

#### 1.3.2.3 感应器

因为通常最终呈现的画面都是以某个分辨率的屏幕显示，每个像素的存在固定的大小，每个像素颜色是由单位面积的采样积分决定的。但是计算机图形学中，为了简化计算，通常采用抽样的方式计算最终的结果。

## 1.4 采样和反走样

这个部分的内容大部分是介绍信息理论中的采样和还原的理论，只要大概了解就好了，对于学通信或者是信息专业的学生来说有没有很熟悉，采样定理、卷积，仿佛回到了大学时代。

关于抗锯齿的实现有很多实现的方案，这个里面有好多可以学习的内容。

## 1.5 基于物理的渲染

早期的工业运用中大都使用一些非常近似的模型，这些模型能够产生比较理想的效果，然而这些图像不是物理上正确的。物理正确主要指光在场景中的传输保持能量守恒。基于物理的渲染能够是渲染的结果更能够接近物理世界的品质。

### 1.5.1 双向反射分布函数

表面光滑的时候光线遵守折射和反射定律，但是物理世界中的大部分物体都不是绝对光滑的。在微观表面上光和物体任准守折射和反射定律。

从结果分析，由于微观结构的存在，它使得来自每个方向的每束光在表面的各个方向上具有一个特定的分布函数，这个分布函数决定于很多因素，粗糙度，金属结构等等。

BRDF 双向反射分布函数，用来表示物体表面的反射。它表示反射的反射的辐射亮度增量与入射方向辐射照度增量的比率。

BRDF 函数具有四个变量，入射反向、反射方向，每个方向可以用方位角和顶点角表示。 

BRDF 的值表示入射光线方向单位立体角的能量在反射方向上的比率。

BRDF 的性质：1.赫姆霍兹互反律、2.能量守恒定律

BRDF 遵循物理定律，所以使用 BRDF 模型计算光和表面的交互的渲染技术通常称为基于物理的着色。

BRDF 方程

![BRDF 方程](/pic/BRDF.jpg)

翻译成

![BRDF 方程](/pic/BRDF1.jpg)

这个方程的前面表示漫反射，后面的部分是镜面反射，但是这个方程由同时表示直接光和间接光。所以排列组合一下变成，直接光漫反射、直接光镜面反射、间接光漫反射、间接光镜面反射。

一个我看过的讲的很好的 [PBR 材质的实现](https://zhuanlan.zhihu.com/p/68025039), 里面讲述了整个 BRDF 的 unity的实现。

[Unreal Engine 4 的 BRDF 的实现](https://github.com/EpicGames/UnrealEngine/blob/bf95c2cbc703123e08ab54e3ceccdd47e48d224a/Engine/Shaders/Private/BRDF.ush)

### 1.5.2 菲涅尔公式

菲涅尔公式解释的是光线从一种介质进入另一种介质反射和折射的比率，公式仅仅取决于入射角度和两种介质的折射系数。

![菲涅尔反射率对于金属的影响很小，对于非金属的影响很大](/pic/菲涅尔反射率对于金属和非金属的区别.jpeg)

下面的代码是 UE4 中使用的菲涅尔的近似方程

```hlsl
// [Schlick 1994, "An Inexpensive BRDF Model for Physically-Based Rendering"]
float3 F_Schlick( float3 SpecularColor, float VoH )
{
	float Fc = Pow5( 1 - VoH );					// 1 sub, 3 mul
	//return Fc + (1 - Fc) * SpecularColor;		// 1 add, 3 mad
	
	// Anything less than 2% is physically impossible and is instead considered to be shadowing
	return saturate( 50.0 * SpecularColor.g ) * Fc + (1 - Fc) * SpecularColor;
	
}
```

### 1.5.3 微面元理论

主流的游戏引擎都是使用微面原理轮的BRDF模型

大多数物体在一个像素的尺度上都不是完全光滑的，这个尺度下，一个像素的表面通常接收很多束光，这些光和不同法线的微面元发生交互，从而反射或折射到不同的方向。

这种微光结构非常复杂，无法通过几何解析，通常使用统计方式模拟这种微观结构。

BRDF 通常分为两个部分进行计算光泽部分和漫反射部分，漫反射出于对性能的考虑，通常是一个常数。

光泽部分的 BRDF 模型：

![BRDF 方程](/pic/BRDF2.jpeg)

包含菲涅尔反射率RF，半法线分布函数D，几何遮挡函数G








